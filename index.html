<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>צ'אט GPT Puter עם</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: sans-serif; direction: rtl; background: #f5f8fc; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    textarea, input, select { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
    .response { white-space: pre-line; border: 1px solid #ccc; padding: 10px; min-height: 100px; }
    .error { color: red; margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>צ'אט GPT Puter עם</h2>
    <div id="user-info"></div>
    <button id="login-btn">🔑 התחבר</button>
    <button id="logout-btn" class="hidden">🛋️ התנתק</button>

    <textarea id="prompt" placeholder="הקלד שאלה..."></textarea>
    <button onclick="sendPrompt()">שלח</button>
    <div id="response" class="response"></div>
    <div id="error" class="error"></div>
  </div>

  <script>
    async function checkAuth() {
      try {
        const user = await puter.auth.me();
        if (user?.username) {
          document.getElementById('user-info').innerHTML = `מחובר כברה: <strong>🔐 ${user.username}</strong>`;
          document.getElementById('login-btn').classList.add('hidden');
          document.getElementById('logout-btn').classList.remove('hidden');
        }
      } catch (err) {
        console.warn('Not authenticated yet.');
      }
    }

    async function login() {
      await puter.auth.login();
      location.reload();
    }

    async function logout() {
      await puter.auth.logout();
      location.reload();
    }

    document.getElementById('login-btn').onclick = login;
    document.getElementById('logout-btn').onclick = logout;
    checkAuth();

    async function sendPrompt() {
      const promptText = document.getElementById('prompt').value.trim();
      const outputEl = document.getElementById('response');
      const errorEl = document.getElementById('error');
      outputEl.innerHTML = '';
      errorEl.innerHTML = '';

      if (!promptText) return;

      const maxLen = 1500;
      const chunks = [];
      for (let i = 0; i < promptText.length; i += maxLen) {
        chunks.push(promptText.substring(i, i + maxLen));
      }

      console.log(`נשלחו של ${chunks.length} קטעים`);

      for (let i = 0; i < chunks.length; i++) {
        const part = chunks[i];
        console.log(`קטע ${i+1}: ${part.length} תווים`);
        try {
          const resp = await puter.ai.chat(part, { model: 'claude', stream: true });
          for await (const sub of resp) {
            outputEl.innerHTML += sub?.text?.replaceAll('\n', '<br>') || '';
          }
        } catch (err) {
          console.error("שגיאה בפרומפט:", err);
          errorEl.textContent = `שגיאה: ${err?.message || err || 'לא ידועה'}`;
          break;
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  </script>
</body>
</html>
